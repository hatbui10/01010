<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>T√°ch & ph√¢n t√≠ch chu·ªói bit</title>

<style>
body {
    font-family: "Segoe UI", Arial, sans-serif;
    padding: 40px;
    background: #0b1220;
    color: #e5e7eb;
}

h2 { color: #93c5fd; }

input {
    padding: 10px 12px;
    font-size: 15px;
    width: 260px;
    border-radius: 8px;
    border: 1px solid #334155;
    background: #020617;
    color: #e5e7eb;
    margin-bottom: 10px;
}

button {
    padding: 12px 26px;
    font-size: 16px;
    border-radius: 999px;
    border: none;
    background: linear-gradient(135deg, #6366f1, #4f46e5);
    color: #fff;
    cursor: pointer;
    font-weight: 600;
}

#preview {
    margin-top: 24px;
    max-height: 420px;
    overflow: auto;
}

.line {
    font-family: "JetBrains Mono", Consolas, monospace;
    padding: 6px 10px;
    border-radius: 8px;
    margin-bottom: 4px;
    white-space: pre;
}

.normal { background: #020617; }

.matchN {
    background: linear-gradient(90deg, #facc15, #fde047);
    color: #422006;
    font-weight: 700;
}

.matchGroup {
    background: linear-gradient(90deg, #22c55e, #4ade80);
    color: #022c22;
    font-weight: 700;
}

.info {
    margin-top: 14px;
    font-weight: 600;
    color: #93c5fd;
}

.jump {
    color: #60a5fa;
    cursor: pointer;
    margin-right: 8px;
    text-decoration: underline;
}

.form-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 14px 24px;
    max-width: 560px;
}
.form-group label {
    display: block;
    margin-bottom: 4px;
    font-weight: 600;
    color: #c7d2fe;
}

</style>
</head>

<body>

<h2>T√°ch & ph√¢n t√≠ch chu·ªói bit</h2>

<div class="form-grid">

    <!-- C·ªòT TR√ÅI -->
    <div class="form-group">
        <label>Marker:</label>
        <input id="marker" value="1000">
    </div>

    <div class="form-group">
        <label>S·ªë d√≤ng li√™n ti·∫øp (N):</label>
        <input id="groupSize" type="number" value="1">
    </div>

    <div class="form-group">
        <label>T·ªïng s·ªë bit (cho N d√≤ng):</label>
        <input id="targetBits" type="number" value="15">
    </div>

    <!-- C·ªòT PH·∫¢I -->
    <div class="form-group">
        <label>S·ªë bit c·∫ßn ki·ªÉm tra sau marker (K):</label>
        <input id="bitCount" type="number" value="5">
    </div>

    <div class="form-group">
        <label>Chu·ªói bit c·∫ßn t√¨m:</label>
        <input id="pattern" placeholder="vd: 01000">
    </div>

    <div class="form-group">
        <label>Ch·ªçn file TXT:</label>
        <input type="file" id="fileInput" accept=".txt">
    </div>

</div>

<button onclick="processFile()">X·ª≠ l√Ω</button>
<button onclick="downloadTXT()">T·∫£i file TXT</button>

<div class="info" id="summary"></div>
<div class="info" id="positions"></div>
<div id="preview"></div>



<script>
let lastOutputText = "";

function processFile() {
    const marker = markerValue();
    const file = document.getElementById("fileInput").files[0];
    const K = +bitCount.value;

    if (!marker || !file) {
        alert("Thi·∫øu marker ho·∫∑c file");
        return;
    }

    const reader = new FileReader();
    reader.onload = e => {
        const raw = e.target.result.replace(/\s+/g, "");
        let lines = [];
        let i = 0;

        while (i <= raw.length - marker.length) {
            if (raw.substr(i, marker.length) === marker) {
                const start = i + marker.length;
                const firstBits = raw.substr(start, K);

                // üî• t√¨m marker k·∫ø ti·∫øp
                let nextMarker = raw.indexOf(marker, start + K);
                if (nextMarker === -1) nextMarker = raw.length;

                const rest = raw.substring(start + K, nextMarker);

                lines.push(
                    marker + "    " + firstBits + "    " + rest
                );

                i = nextMarker;
            } else {
                i++;
            }
        }

        analyze(lines);
    };

    reader.readAsText(file);
}







function analyze(lines) {
    const N = +groupSize.value;
    const target = +targetBits.value;
    const K = +bitCount.value;
    const pattern = document.getElementById("pattern").value.trim();

    const preview = document.getElementById("preview");
    const summary = document.getElementById("summary");
    const positions = document.getElementById("positions");

    const bitLen = [];
    const matchN = Array(lines.length).fill(false);
    const matchGroup = Array(lines.length).fill(false);
    const hits = [];
    const outputLines = [];

    // 1Ô∏è‚É£ t√°ch & t√≠nh ƒë·ªô d√†i bit + ki·ªÉm tra K-bit
    lines.forEach((l, i) => {
        const parts = l.split(/\s+/);
        const marker = parts[0] || "";
        const firstBits = parts[1] || "";
        const rest = parts[2] || "";

        bitLen[i] = marker.length + firstBits.length + rest.length;

        if (pattern && firstBits === pattern && firstBits.length === K) {
            matchN[i] = true;
        }
    });

    // 2Ô∏è‚É£ ki·ªÉm tra nh√≥m N d√≤ng (ph·∫£i c√≥ K-bit kh·ªõp)
    for (let i = 0; i <= lines.length - N; i++) {
        let sum = 0;
        let hasKMatch = false;

        for (let j = 0; j < N; j++) {
            sum += bitLen[i + j];
            if (matchN[i + j]) hasKMatch = true;
        }

        if (sum === target && hasKMatch) {
            for (let j = 0; j < N; j++) {
                matchGroup[i + j] = true;
            }
            hits.push(i + 1);
        }
    }

    // 3Ô∏è‚É£ render preview + xu·∫•t file
    preview.innerHTML = "";

    lines.forEach((l, i) => {
        const div = document.createElement("div");
        div.id = "line-" + (i + 1);
        div.className =
            "line " +
            (matchGroup[i] ? "matchGroup" :
             matchN[i] ? "matchN" : "normal");

        const text = `#${i + 1}  ${l}`;
        div.textContent = text;
        preview.appendChild(div);

        const tag =
            matchGroup[i] ? "[GROUP]" :
            matchN[i] ? "[K-BIT]" : "[OK]";

        outputLines.push(`${tag} ${text}`);
    });

    // 4Ô∏è‚É£ summary: hi·ªán c√°c d√≤ng t√¥ m√†u
    const groupLines = [];
    const kbitLines = [];

    lines.forEach((_, i) => {
        if (matchGroup[i]) groupLines.push(i + 1);
        else if (matchN[i]) kbitLines.push(i + 1);
    });

   summary.innerHTML = `
    T·ªïng d√≤ng: <b>${lines.length}</b><br>

    GROUP: <b>${groupLines.length}</b>
    ${groupLines.map(i =>
        `<span class="jump" onclick="jump(${i})">#${i}</span>`
    ).join(" ")}

    <br>

    K-BIT: <b>${kbitLines.length}</b>
    ${kbitLines.map(i =>
        `<span class="jump" onclick="jump(${i})">#${i}</span>`
    ).join(" ")}
`;

    positions.innerHTML =
        hits.map(i =>
            `<span class="jump" onclick="jump(${i})">#${i}</span>`
        ).join("");

    lastOutputText = outputLines.join("\n");
}










function downloadTXT() {
    if (!lastOutputText) {
        alert("Ch∆∞a c√≥ k·∫øt qu·∫£. H√£y b·∫•m X·ª≠ l√Ω tr∆∞·ªõc.");
        return;
    }

    const blob = new Blob([lastOutputText], { type: "text/plain" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "ket_qua_phan_tich.txt";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);

    URL.revokeObjectURL(url);
}

function jump(n) {
    document.getElementById("line-" + n)
        .scrollIntoView({ behavior: "smooth", block: "center" });
}

function markerValue() {
    const raw = document.getElementById("marker").value;
    return raw.replace(/[^01]/g, "");
}
</script>

</body>
</html>

